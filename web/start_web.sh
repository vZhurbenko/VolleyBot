#!/bin/bash
# ะกะบัะธะฟั ะดะปั ะทะฐะฟััะบะฐ ะฒะตะฑ-ัะตัะฒะตัะฐ ะฐะฒัะพัะธะทะฐัะธะธ ะฒ ัะพะฝะต ั ัะพััะฐะฝะตะฝะธะตะผ PID

# ะะตัะตัะพะดะธะผ ะฒ ะดะธัะตะบัะพัะธั ัะบัะธะฟัะฐ (ะฝะตะทะฐะฒะธัะธะผะพ ะพั ัะพะณะพ, ะพัะบัะดะฐ ะทะฐะฟััะตะฝ)
cd "$(dirname "$0")" || exit 1

# ะัะพะฒะตััะตะผ, ะฝะต ะทะฐะฟััะตะฝ ะปะธ ัะถะต ัะตัะฒะตั
if [ -f "web.pid" ]; then
    PID=$(cat web.pid)
    if ps -p $PID > /dev/null; then
        echo "ะะตะฑ-ัะตัะฒะตั ัะถะต ะทะฐะฟััะตะฝ ั PID: $PID"
        exit 1
    else
        # ะคะฐะนะป PID ัััะตััะฒัะตั, ะฝะพ ะฟัะพัะตัั ะฝะต ะทะฐะฟััะตะฝ - ัะดะฐะปัะตะผ ัะฐะนะป
        rm -f web.pid
    fi
fi

# ะะบัะธะฒะธััะตะผ ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต
source ../venv/bin/activate

# ะัะธัะฐะตะผ ััะฐััะน ะปะพะณ
> web_output.log

# ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั ะฒ ัะพะฝะต
nohup python3 run.py > web_output.log 2>&1 &
WEB_PID=$!

# ะะดัะผ ะฝะตะผะฝะพะณะพ ะธ ะฟัะพะฒะตััะตะผ, ะฝะต ัะฟะฐะป ะปะธ ัะตัะฒะตั ััะฐะทั
sleep 2

# ะัะพะฒะตััะตะผ, ะถะธะฒ ะปะธ ะฟัะพัะตัั
if ! ps -p $WEB_PID > /dev/null; then
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ะทะฐะฟััะบะต ะฒะตะฑ-ัะตัะฒะตัะฐ!"
    echo ""
    cat web_output.log
    exit 1
fi

# ะกะพััะฐะฝัะตะผ PID ะฒ ัะฐะนะป
echo $WEB_PID > web.pid

echo "โ ะะตะฑ-ัะตัะฒะตั ะทะฐะฟััะตะฝ ะฒ ัะพะฝะต ั PID: $WEB_PID"
echo "๐ ะะพะณะธ ะทะฐะฟะธััะฒะฐัััั ะฒ ัะฐะนะป: web_output.log"
echo "๐ ะะดัะตั: http://localhost:8000"
echo ""
echo "ะะปั ะพััะฐะฝะพะฒะบะธ ะฒัะฟะพะปะฝะธัะต: ./stop_web_by_pid.sh"
